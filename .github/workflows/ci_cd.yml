name: CI/CD — Test and Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  # ─── Job 1: Run unit tests ───────────────────────────────────────────────────
  test:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build test image
        run: docker build -t vitiscan-streamlit-tests -f tests/Dockerfile .

      - name: Run tests
        run: docker run --rm vitiscan-streamlit-tests

  # ─── Job 2: Deploy to HuggingFace Spaces ────────────────────────────────────
  # Only runs if the test job passes
  deploy:
    name: Deploy to HuggingFace Spaces
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history — required by HuggingFace git push
          fetch-depth: 0
          # Pull LFS files if any are tracked
          lfs: true

      - name: Push to HuggingFace Spaces
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git config user.email "ci@vitiscan.ai"
          git config user.name "Vitiscan CI"
          git push \
            https://${{ vars.HF_USERNAME }}:$HF_TOKEN@huggingface.co/spaces/${{ vars.HF_USERNAME }}/${{ vars.HF_SPACE_NAME }} \
            main